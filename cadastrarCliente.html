<script type="module">
  import { URL_BACKEND } from '/ajudante-app/js/navegacao.js';

  let selosDisponiveis = [];
  let selosSelecionados = [];

  async function fetchSelos() {
    try {
      const response = await fetch(URL_BACKEND, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ acao: 'listarSelos' })
      });

      const resultado = await response.json();
      if (resultado.sucesso) {
        selosDisponiveis = resultado.dados;
        localStorage.setItem('cacheSelos', JSON.stringify(selosDisponiveis));
      }
    } catch (err) {
      console.error('Erro ao buscar selos online, tentando usar cache:', err);
      selosDisponiveis = JSON.parse(localStorage.getItem('cacheSelos') || '[]');
    }
  }

  function filtrarSelos() {
    const termo = document.getElementById("buscaSelo").value.toLowerCase();
    const lista = document.getElementById("listaSelos");
    lista.innerHTML = "";

    if (termo.length === 0) {
      lista.style.display = "none";
      return;
    }

    const filtrados = selosDisponiveis.filter(s => s.toLowerCase().includes(termo));
    filtrados.forEach(selo => {
      const li = document.createElement("li");
      li.textContent = selo;
      li.onclick = () => selecionarSelo(selo);
      lista.appendChild(li);
    });
    lista.style.display = "block";
  }

  function selecionarSelo(selo) {
    if (!selosSelecionados.includes(selo)) {
      selosSelecionados.push(selo);
      renderizarSelosSelecionados();
    }
    document.getElementById("buscaSelo").value = "";
    document.getElementById("listaSelos").style.display = "none";
  }

  function removerSelo(selo) {
    selosSelecionados = selosSelecionados.filter(s => s !== selo);
    renderizarSelosSelecionados();
  }

  function renderizarSelosSelecionados() {
    const container = document.getElementById("selosSelecionados");
    container.innerHTML = "";
    selosSelecionados.forEach(selo => {
      const div = document.createElement("div");
      div.className = "selo-item";
      div.innerHTML = `${selo} <button onclick="removerSelo('${selo}')">‚ùå</button>`;
      container.appendChild(div);
    });
  }

  async function salvarCliente() {
    const cliente = {
      nome: document.getElementById("nome").value,
      endereco: document.getElementById("endereco").value,
      rota: document.getElementById("rota").value,
      selos: selosSelecionados
    };

    if (navigator.onLine) {
      try {
        const response = await fetch(URL_BACKEND, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ acao: "cadastrarCliente", cliente })
        });
        const resultado = await response.json();
        if (resultado.sucesso) {
          alert("Cliente salvo com sucesso!");
        } else {
          alert("Erro ao salvar: " + resultado.mensagem);
        }
      } catch (err) {
        console.error(err);
        alert("Erro na comunica√ß√£o com o servidor.");
      }
    } else {
      let clientesPendentes = JSON.parse(localStorage.getItem("clientesPendentes") || "[]");
      clientesPendentes.push(cliente);
      localStorage.setItem("clientesPendentes", JSON.stringify(clientesPendentes));
      alert("üì¶ Cliente salvo localmente. Ser√° enviado quando a conex√£o voltar.");
    }
  }

  async function sincronizarClientes() {
    const pendentes = JSON.parse(localStorage.getItem("clientesPendentes") || "[]");
    if (!pendentes.length || !navigator.onLine) return;

    for (let cliente of pendentes) {
      try {
        const response = await fetch(URL_BACKEND, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ acao: "cadastrarCliente", cliente })
        });

        const resultado = await response.json();
        if (!resultado.sucesso) {
          console.error("Erro ao sincronizar cliente:", resultado.mensagem);
        }
      } catch (err) {
        console.error("Erro na sincroniza√ß√£o de clientes:", err);
      }
    }

    localStorage.removeItem("clientesPendentes");
  }

  window.addEventListener("online", () => {
    sincronizarClientes();
  });

  window.onload = () => {
    fetchSelos();
    if (navigator.onLine) sincronizarClientes();
  };

  window.filtrarSelos = filtrarSelos;
  window.removerSelo = removerSelo;
  window.salvarCliente = salvarCliente;
</script>
