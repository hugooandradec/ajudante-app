<!-- RESUMO: Página de cadastro de cliente com busca de selos já cadastrados e sincronização offline -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastrar Cliente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script type="module" src="js/navegacao.js"></script>
  <script type="module" src="js/sincronizador.js"></script>
  <style>
    /* ... (Mesmo estilo anterior) ... */
  </style>
</head>
<body>
  <header>
    <div class="titulo-esquerda">
      <a href="gerenciarClientes.html"><i class="fas fa-arrow-left"></i></a>
      Cadastrar Cliente
    </div>
    <div class="header-right">
      <i class="fas fa-circle status-icon" id="icone-status" style="color: gray;"></i>
      <span class="usuario" id="usuario-logado">Usuário</span>
      <button class="logout-btn" onclick="logout()" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <div class="container">
    <label for="nome">Nome do Cliente</label>
    <input type="text" id="nome" />

    <label for="endereco">Endereço</label>
    <input type="text" id="endereco" />

    <label for="rota">Rota</label>
    <input type="text" id="rota" />

    <label>Máquinas</label>
    <button class="btn adicionar" onclick="abrirPopupMaquinas()">
      <i class="fas fa-plus"></i> Adicionar Máquina
    </button>
    <div class="maquinas-selecionadas" id="maquinasSelecionadas"></div>

    <button class="btn salvar" onclick="salvarCliente()">
      <i class="fas fa-save"></i> Salvar Cliente
    </button>
  </div>

  <!-- Modal popup (igual ao anterior) -->
  <div class="popup" id="popupMaquinas"> ... </div>

  <script type="module">
    import { logout, atualizarStatusConexao, exibirUsuarioLogado } from './js/navegacao.js';
    import { salvarComSincronizacao, obterSelosDisponiveis } from './js/servicos.js';

    let selosDisponiveis = [];
    let maquinasSelecionadas = [];

    window.addEventListener("load", async () => {
      atualizarStatusConexao();
      exibirUsuarioLogado();
      selosDisponiveis = await obterSelosDisponiveis();
    });

    window.logout = logout;

    window.abrirPopupMaquinas = function () {
      const popup = document.getElementById("popupMaquinas");
      popup.style.display = "flex";
      filtrarSelos("");
    };

    window.filtrarSelos = function () {
      const termo = document.getElementById("buscaMaquina").value.toLowerCase();
      const filtrados = selosDisponiveis.filter(s => s.toLowerCase().includes(termo));
      exibirSelos(filtrados);
    };

    function exibirSelos(selos) {
      const lista = document.getElementById("listaSelos");
      lista.innerHTML = "";
      selos.forEach(selo => {
        const div = document.createElement("div");
        div.textContent = selo;
        div.onclick = () => selecionarMaquina(selo);
        lista.appendChild(div);
      });
    }

    function selecionarMaquina(selo) {
      if (!maquinasSelecionadas.includes(selo)) {
        maquinasSelecionadas.push(selo);
        atualizarMaquinasSelecionadas();
      }
      document.getElementById("popupMaquinas").style.display = "none";
    }

    window.removerMaquina = function (selo) {
      maquinasSelecionadas = maquinasSelecionadas.filter(m => m !== selo);
      atualizarMaquinasSelecionadas();
    };

    function atualizarMaquinasSelecionadas() {
      const container = document.getElementById("maquinasSelecionadas");
      container.innerHTML = "";
      maquinasSelecionadas.forEach(selo => {
        const tag = document.createElement("div");
        tag.className = "selo-tag";
        tag.innerHTML = `${selo} <span class="remover-selo" onclick="removerMaquina('${selo}')">&times;</span>`;
        container.appendChild(tag);
      });
    }

    window.salvarCliente = async function () {
      const nome = document.getElementById("nome").value.trim();
      const endereco = document.getElementById("endereco").value.trim();
      const rota = document.getElementById("rota").value.trim();

      if (!nome || !endereco || !rota) {
        alert("Preencha todos os campos obrigatórios.");
        return;
      }

      const cliente = { nome, endereco, rota, maquinas: maquinasSelecionadas };
      await salvarComSincronizacao("cadastrarCliente", cliente);

      alert("Cliente salvo!");
      document.getElementById("nome").value = "";
      document.getElementById("endereco").value = "";
      document.getElementById("rota").value = "";
      maquinasSelecionadas = [];
      atualizarMaquinasSelecionadas();
    };
  </script>
</body>
</html>